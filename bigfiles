#!/bin/bash

# Cleanup temp files
cleanup() {
    rm -rf $FILE_SIZE $FILE_NAMES $AMOUNT_FOUND $FILES_FOUND $PLC_FILES $REPORT_RESULTS
}

save() {
    cp ${PLC_FILES} ~/.
    cleanup
    exit
}

control_c() {
    cleanup
    stty echo
    exit $?
}

# trap keyboard interrupt (control-c)
trap control_c SIGINT

# Declare where the temp files will be stored
FILES_FOUND=/tmp/files_found.txt
FILE_NAMES=/tmp/file_names.txt
FILE_SIZE=/tmp/file_size.txt
AMOUNT_FOUND=/tmp/amount_found.txt
PLC_FILES=/tmp/plc_files.txt
REPORT_RESULTS=/tmp/results.csv

# Uses first argument to set percentage of full HDD PLCs to check for. 50 or greater by default
# Account for if a first arguement exist and if it is a number
if [ -n "${1}" ] && [[ ${1} != *[!0-9]* ]]; then
    PERCENT=${1}
else
    PERCENT=50
fi

# How many top offenders to look for, by default it find the top five big files/folders
# Account for if a second arguement exist and if it is a number
if [ -n "${2}" ] && [[ ${2} != *[!0-9]* ]]; then
    TOP_FILES=${2}
else
    TOP_FILES=5
fi

echo "Please provide your report code (ie: hYqEmd) "
read code
if [ -z "$code" ]; then
    echo "No code provided...exiting"
    exit 0
fi

# Recommend services.hq be a part of your SSH .config file
scp services.hq:/tmp/plc_report_${code}/results.csv $REPORT_RESULTS

# REBOOT_PLC will always be the last arguement provided
REBOOT_PLC=$BASH_ARGV
REPORT=$(cat ${REPORT_RESULTS})
#Take the oringal report file and only pull out the PLC's IPs based on percent of free disk space
ROOT_QUERY=$(echo "$REPORT" | awk -F',' '{print $7 " - " $1}' | awk -F'%' '{print $1 $2}' | awk 'int($1)>='$PERCENT | sort -n)
# Narrow down to list of IPs only
PLCS=$(echo "$ROOT_QUERY" | awk '{print $3}')
# List of Percent full per IP address
PERC=$(echo "$ROOT_QUERY" | awk '{print $1" " $3}')

# Log in and get top x big files (determined by TOP_FILES)
for plcs in ${PLCS}; do
    echo "Checking ${plcs}..."
    PERC_FULL=$(echo "$PERC" | grep ${plcs} | awk '{print $1}')
    echo -e "\n${plcs} - ${PERC_FULL}% Full" &>> $PLC_FILES
    sshpass -f ~/.plcssh ssh -oStrictHostKeyChecking=no root@${plcs} find /* -type f -exec du -a {} + 2>/dev/null | sort -n | tail -${TOP_FILES} &>> $FILES_FOUND
    cat ${FILES_FOUND} | tail -${TOP_FILES} &>> $PLC_FILES
    # Determine if we should reboot the PLCs while we are logged in
    # This requires the info script to work
    if [ "${REBOOT_PLC}" == "reboot" ]; then
        echo "Rebooting ${plcs}..."
        info -x ${plcs}
    fi
done

# Take the list of big files provided above and organize it
# Create a list of only unique items and total how many instances of each file
# Get average size of the files found and present in size=MB
PARSE=$(cat "$FILES_FOUND" | awk '{print $2}' | sort -n | uniq)
for size in $PARSE; do
    SUM=0
    TOTAL=$(cat $FILES_FOUND | grep $size | awk '{print $1}')
    LINES=$(cat $FILES_FOUND | grep $size | wc -l)
    for values in $TOTAL; do
        SUM=`expr $SUM + $values`
    done
    AVERAGE=`expr $SUM / $LINES`
    echo "$AVERAGE" | awk '{GB = $1 / 1024 ; print GB " MB"}' >> $FILE_SIZE
    echo "$LINES" >> $AMOUNT_FOUND
done

# Display the results to the user in a nicely organzied fashion
echo "$PARSE" >> $FILE_NAMES
echo "Average Size of File | File/Folder Name | # of PLCs File was Found"
paste -d ':' "$FILE_SIZE" "$FILE_NAMES" "$AMOUNT_FOUND" | awk -F':' '{print $1": "$2" - "$3" PLC(s) found with file"}' | sort -n

while true; do
    read -p "Do you wish to save individual PLC file info? " yn
    case $yn in
        [Yy]* ) save; break;;
        [Nn]* ) exit;;
        * ) echo "Please answer yes or no.";;
    esac
done

# Remove temp files
cleanup &>/dev/null
